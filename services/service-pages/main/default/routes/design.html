<html>

<head>
    <script src="https://builder.steedos.com/js/axios/axios.min.js"></script>
    <script src="https://builder.steedos.com/js/builder-fiddle/builder-fiddle.umd.js"></script>
</head>

<body style="margin: 0;padding: 0;">

    <builder-fiddle host="https://builder.steedos.com/amis"></builder-fiddle>

    <script>
        let comp = document.querySelector('builder-fiddle')
        var params = new URLSearchParams(location.search);
        var pageId = params.get("pageId");
        // /pageVersion/:pageId/latest

        axios.get(`/service/api/page/pageVersion/${params.get("pageId")}/latest/`).then(function (response) {
            let schema = response.data.schema;
            if (typeof schema === "string") {
                schema = JSON.parse(schema)
            }
            const data = {
                AmisSchema: schema || {}
            };
            console.log("record data", data)
            comp.data = data;
        }).catch(function (error) {
            // handle error
            console.log(error);
        }).then(function () {
            // always executed
        });

        const onWindowMessage = function (event) {
            const { data } = event;
            if (data) {
                if (data.type === 'builder.saveContent') {
                    axios.put(`/service/api/page/pageVersion/${params.get("pageId")}`, {
                        schema: JSON.stringify(data.data.AmisSchema) //直接存储json格式会导致react form异常。
                    }).then(function (response) {
                        window.postMessage(
                        {
                            type: 'builder.contentSaved',
                        },
                        '*'
                        );
                    }).catch(function (error) {
                        // handle error
                        console.log(error);
                    }).then(function () {
                        // always executed
                    })
                }
            }
        }

        window.addEventListener('message', onWindowMessage);

    </script>
</body>

</html>